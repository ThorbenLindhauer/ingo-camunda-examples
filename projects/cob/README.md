cob
=========================

This project has been generated by the Maven archetype
[camunda-archetype-servlet-war-7.1.3](http://docs.camunda.org/latest/guides/user-guide/#process-applications-maven-project-templates-archetypes).

Built and tested against Camunda BPM version 7.2.0.


Show me the important parts!
----------------------------


Fast Track user task
------------------------
In the process definition, the user tasks have an attached non-canceling message receive event called override. If the process instance receives an override message, it will create an additional task 'Review Override Request' for Management. In this task, the user can approve the Override and the original request and decide to publish the counterparty immediately or reject the override.

If you are interested how to do it with the Java API, check out the `CounterpartyOnboardingTest.java`, method `overrideRequest()`.

To do it with the REST-API, you have to call two rest services to create the message event.

The first one: `POST /execution` with payload

    {
    "processVariables":
    [{"name": "aVariableName", "operator": "eq", "value": aValue}],
    "messageEventSubscriptionName": "theMessageName"}
    }

for example:

    http://localhost:8080/camunda/api/engine/engine/default/execution

with payload:

    {
    "processVariables":
    [{"name":"CPTYNumber", "operator":"eq", "value": 6}],
    "messageEventSubscriptionName": "override"}
    }  

It returns the list of executions that are expecting a message called 'override'. It is a list because there could be possibly more than one task available, if the process instance has tasks in the compliance and tax branch.

    [{"id":"885628f4-792b-11e4-b932-7ce9d3b8f4dd",
    "processInstanceId":"72516907-792b-11e4-b932-7ce9d3b8f4dd",
    "ended":false},
    {"id":"8856c53c-792b-11e4-b932-7ce9d3b8f4dd",
    "processInstanceId":"72516907-792b-11e4-b932-7ce9d3b8f4dd",
    "ended":false}]

Then you can get the first executionId from the list and use it in the second rest call to send this task the message with the payload: `POST /execution/{id}/messageSubscriptions/{messageName}/trigger`

for example:

    http://localhost:8080/camunda/api/engine/engine/default/execution/885628f4-792b-11e4-b932-7ce9d3b8f4dd/messageSubscriptions/override/trigger
    
with payload:

    {"variables":
    {"overrideReason" : {"value": "I want to trade with this counterparty today"}}
    }

After this call the task 'review override request' can be found in the tasklist of management.

Ad Hoc Approval Task
--------------------

To make an other person approve a request instantly, there are several possible ways.

### Approval in the following task

In this process, if the COB-User wants an instant approval by the tax team, he enters the reason on the form, checks the instant approval and the process will go directly to the 'check for tax rules' task. The tax team can enter some comments and can give it back to the COB to amend the request. After amending the process instance will instantiate the tax 'check for tax rules' again to review the amended data.

### Approval by another assignee

In another process the you can do an adhoc approval just assigning the task to somebody else. In the camunda tasklist you enter another userid in the assignee box on the upper right site of the task form.

![tasklist](readme-images/reassign-task-camunda-tasklist.png)

After changing the assignee the task will immediately appear in the personal task list of the new user.

You have to call `POST /task/{id}/assignee` with the new userId as payload. [see the REST API](http://docs.camunda.org/latest/api-references/rest/#task-set-assignee) 

When the new user completes the task, the process instance will continue with the next task.

### Approval by delegating to another user 

The third possibility to hand the task over to another person is to delegate it to someone else. You can delegate a task with the REST call `POST /task/{id}/delegate` and the userId as payload. [see the REST API](http://docs.camunda.org/latest/api-references/rest/#task-delegate-task) The call will set the delegation state of the task to `PENDING`. 

If the task was claimed by a user before, this user is the assignee of the task. While delegating the task, the assignee will get the owner of the task and the user who gets the task delegated is the new assignee. The delegated user will find the task in his personal tasklist. 

A snippet from the task attributes:

    name: "Review and complete onboarding request"
    assignee: "mary"
    delegationState: "PENDING"
    owner: "demo"

If the delegated user completes the task in the camunda tasklist, the delegation gets resolved and the task is handed back to the assignee (if someone had claimed the task before) or into the group list. This is done with the REST call `POST /task/{id}/resolve` with variables in the payload. The variables will reflect the changes, the user had done on the process instance. [see the REST API](http://docs.camunda.org/latest/api-references/rest/#task-resolve-task). The delegation state of the task is set to `RESOLVED`. 

    name: "Review and complete onboarding request"
    assignee: "demo"
    delegationState: "RESOLVED"

If a user claimed the task before delegation, he can now complete the task and perhaps change some data on the form fields before. If the task was delegated from a group-list, a user has to claim the task into his personal task list before completing it.

![History of delegations](readme-images/delegate-task-history-tasklist.png)

### Approval by another team

The fourth possibility to give the task to another team to work on it is to change the candidate-groups behind the scene. In the camunda tasklist this can be done by clicking on the groups on the top of the from and add another group and delete the old one. Because there is a one to many relationship between task and groups you always have to add a group and delete the existing to hand over the task to a single group.

![managing groups](readme-images/manage-groups-camunda-tasklist.png)
 
With the REST-API the two calls will be `POST /task/{id}/identity-links` ([See the REST API](http://docs.camunda.org/latest/api-references/rest/#task-add-identity-link)) and `POST /task/{id}/identity-links/delete` ([See the REST API](http://docs.camunda.org/latest/api-references/rest/#task-delete-identity-link)) with the payload of the new identity link. An identity link can either be a user or a group. An example is

    {"groupId": "accounting", "type": "candidate"}
    
### Approval in a predefined task

If you can foresee that you will sometimes need an additional approval with another form for a single user task in the process definition, you can add the approval user task and connect it with a boundary message event to the user task. 

![additional approval](readme-images/additional-approval.png)

To send the message with a REST service, call `POST /message` with some process variables as payload to correlate with the process instance. [See the REST API](http://docs.camunda.org/latest/api-references/rest/#message-deliver-a-message)

Example payload may be:

    {"messageName" : "additionalApprovalMessage",
     "correlationKeys" : {
       "workId": {"value": 1, "type" : "Long"}
     }
    }

And check out the `predefinedApproval()` test method. 

### Approval in a new subtask

The most flexible but also the most challenging way to hand the work to another user is to create a new task. Here you have to manually set in the code the name, the parent task and some more attributes. The new task has no connection via sequence flows to other tasks. If you would like to connect it to the process instance, you have to deal in your Java code with the TaskEntity instead of Task to set the processInstanceId. 

The task has no form key, because it is set in process definition and the new sub task doesn't appear in a process diagram. You have to use a task variable to store a form key and handle this variable in your task list application.

And because the new task is no token on the process instance you have to manage the process variables directly on the process instance. You can't pass them in the `taskService.complete(taskId, variables)` method.  

The REST API doesn't support dealing with the process instance. So have a look into the `handleSubTask()` test method for an example.

Service Level Agreement
-----------------------

First you have to specify the value of the due date for a task in the property Due Date on the user task. The value can be any period defined in the [ISO 8601 standard](http://en.wikipedia.org/wiki/ISO_8601), for example `P2D` for two days or `PT3H` for three hours of time (T). Or a combination like `P3Y6M4DT12H30M5S` representing a duration of "three years, six months, four days, twelve hours, thirty minutes, and five seconds".

The period begins as the user tasks is created.

The due date is evaluated to the end of the period and is available as an attribute in task, also in the REST-Service.

![due date in the task list](readme-images/due-date-camunda-tasklist.png)  

See the [user guide](http://docs.camunda.org/latest/api-references/bpmn20/#tasks-user-task-due-date) for more information. The same can be done with a follow up date. Check the `testDueDate()` method of the test class.

How to use it?
--------------

There is no web interface to access the application.
To get started refer to the `InMemoryH2Test`.

You can also use `ant` to build and deploy the example to an application server.
For that to work you need to copy the file `build.properties.example` to `build.properties`
and configure the path to your application server inside it.
Alternatively, you can also copy it to `${user.home}/.camunda/build.properties`
to have a central configuration that works with all projects generated by the
[Camunda BPM Maven Archetypes](http://docs.camunda.org/latest/guides/user-guide/#process-applications-maven-project-templates-archetypes).

Once you deployed the application you can run it using
[Camunda Tasklist](http://docs.camunda.org/latest/guides/user-guide/#tasklist)
and inspect it using
[Camunda Cockpit](http://docs.camunda.org/latest/guides/user-guide/#cockpit).


Environment Restrictions
------------------------

Built and tested against Camunda BPM version 7.2.0.


Improvements Backlog
--------------------

